#
# Test fetching from stats tables that are nonexistent or corrupted
#

-- source include/have_innodb.inc
# Various sizes printed in this test depend on the page size and the
# functionality tested here is not related to the page size, so we only
# test with 16k page size.
-- source include/have_innodb_16k.inc

call mtr.add_suppression("InnoDB: Error: Table \"mysql\".\"innodb_index_stats\" not found or its tablespace is missing");
call mtr.add_suppression("InnoDB: Error: Fetch of persistent statistics requested for table \"test\".\"test_ps_fetch_corrupted\" but the required persistent statistics storage is not present or is corrupted. Using transient stats instead");

-- vertical_results

CREATE TABLE test_ps_fetch_corrupted
(a INT, PRIMARY KEY (a))
ENGINE=INNODB PERSISTENT_STATS=1;

ANALYZE TABLE test_ps_fetch_corrupted;

SELECT n_rows, clustered_index_size, sum_of_other_index_sizes
FROM mysql.innodb_table_stats WHERE table_name = 'test_ps_fetch_corrupted';

ALTER TABLE mysql.innodb_index_stats RENAME TO mysql.innodb_index_stats_;

FLUSH TABLE test_ps_fetch_corrupted;

SELECT seq_in_index, column_name, cardinality
FROM information_schema.statistics WHERE table_name = 'test_ps_fetch_corrupted'
ORDER BY index_name, seq_in_index;

SELECT
table_rows, avg_row_length, max_data_length, index_length
FROM information_schema.tables WHERE table_name = 'test_ps_fetch_corrupted';

ALTER TABLE mysql.innodb_index_stats_ RENAME TO mysql.innodb_index_stats;

DROP TABLE test_ps_fetch_corrupted;
