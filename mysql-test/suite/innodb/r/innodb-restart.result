SET default_storage_engine=InnoDB;
#
# A series of tests to make sure tables are opened after restart.
# Bug#13357607 Compressed file-per-table tablespaces fail to open
#
set global innodb_file_per_table=on;
set global innodb_file_format='Barracuda';
CREATE TABLE t1(c1 DOUBLE AUTO_INCREMENT KEY, c2 CHAR(10), c3 VARCHAR(100), c4 DATE, c5 TEXT)
ROW_FORMAT=REDUNDANT  ENGINE=InnoDB;
INSERT INTO t1 VALUES (1000000000, 'MySQL', 'InnoDB', '2011-11-11', 'Read this after reboot');
INSERT INTO t1 (SELECT 0, c2, c3, c4, c5 FROM t1);
INSERT INTO t1 (SELECT 0, c2, c3, c4, c5 FROM t1);
INSERT INTO t1 (SELECT 0, c2, c3, c4, c5 FROM t1);
INSERT INTO t1 (SELECT 0, c2, c3, c4, c5 FROM t1);
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `c1` double NOT NULL AUTO_INCREMENT,
  `c2` char(10) DEFAULT NULL,
  `c3` varchar(100) DEFAULT NULL,
  `c4` date DEFAULT NULL,
  `c5` text,
  PRIMARY KEY (`c1`)
) ENGINE=InnoDB AUTO_INCREMENT=1000000027 DEFAULT CHARSET=latin1 ROW_FORMAT=REDUNDANT
SELECT count(*) FROM t1;
count(*)
16
CREATE TABLE t2(c1 DOUBLE AUTO_INCREMENT KEY, c2 CHAR(10), c3 VARCHAR(100), c4 DATE, c5 TEXT)
ROW_FORMAT=COMPACT  ENGINE=InnoDB;
INSERT INTO t2 VALUES (1000000000, 'MySQL', 'InnoDB', '2011-11-11', 'Read this after reboot');
INSERT INTO t2 (SELECT 0, c2, c3, c4, c5 FROM t2);
INSERT INTO t2 (SELECT 0, c2, c3, c4, c5 FROM t2);
INSERT INTO t2 (SELECT 0, c2, c3, c4, c5 FROM t2);
INSERT INTO t2 (SELECT 0, c2, c3, c4, c5 FROM t2);
SHOW CREATE TABLE t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `c1` double NOT NULL AUTO_INCREMENT,
  `c2` char(10) DEFAULT NULL,
  `c3` varchar(100) DEFAULT NULL,
  `c4` date DEFAULT NULL,
  `c5` text,
  PRIMARY KEY (`c1`)
) ENGINE=InnoDB AUTO_INCREMENT=1000000027 DEFAULT CHARSET=latin1 ROW_FORMAT=COMPACT
SELECT count(*) FROM t2;
count(*)
16
CREATE TABLE t3(c1 DOUBLE AUTO_INCREMENT KEY, c2 CHAR(10), c3 VARCHAR(100), c4 DATE, c5 TEXT)
ROW_FORMAT=COMPRESSED  KEY_BLOCK_SIZE=4  ENGINE=InnoDB;
INSERT INTO t3 VALUES (1000000000, 'MySQL', 'InnoDB', '2011-11-11', 'Read this after reboot');
INSERT INTO t3 (SELECT 0, c2, c3, c4, c5 FROM t3);
INSERT INTO t3 (SELECT 0, c2, c3, c4, c5 FROM t3);
INSERT INTO t3 (SELECT 0, c2, c3, c4, c5 FROM t3);
INSERT INTO t3 (SELECT 0, c2, c3, c4, c5 FROM t3);
SHOW CREATE TABLE t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `c1` double NOT NULL AUTO_INCREMENT,
  `c2` char(10) DEFAULT NULL,
  `c3` varchar(100) DEFAULT NULL,
  `c4` date DEFAULT NULL,
  `c5` text,
  PRIMARY KEY (`c1`)
) ENGINE=InnoDB AUTO_INCREMENT=1000000027 DEFAULT CHARSET=latin1 ROW_FORMAT=COMPRESSED KEY_BLOCK_SIZE=4
SELECT count(*) FROM t3;
count(*)
16
CREATE TABLE t4(c1 DOUBLE AUTO_INCREMENT KEY, c2 CHAR(10), c3 VARCHAR(100), c4 DATE, c5 TEXT)
ROW_FORMAT=DYNAMIC  ENGINE=InnoDB;
INSERT INTO t4 VALUES (1000000000, 'MySQL', 'InnoDB', '2011-11-11', 'Read this after reboot');
INSERT INTO t4 (SELECT 0, c2, c3, c4, c5 FROM t4);
INSERT INTO t4 (SELECT 0, c2, c3, c4, c5 FROM t4);
INSERT INTO t4 (SELECT 0, c2, c3, c4, c5 FROM t4);
INSERT INTO t4 (SELECT 0, c2, c3, c4, c5 FROM t4);
SHOW CREATE TABLE t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `c1` double NOT NULL AUTO_INCREMENT,
  `c2` char(10) DEFAULT NULL,
  `c3` varchar(100) DEFAULT NULL,
  `c4` date DEFAULT NULL,
  `c5` text,
  PRIMARY KEY (`c1`)
) ENGINE=InnoDB AUTO_INCREMENT=1000000027 DEFAULT CHARSET=latin1 ROW_FORMAT=DYNAMIC
SELECT count(*) FROM t4;
count(*)
16
#
# Test that the DATA DIRECTORY is visible after restart.
#
CREATE TABLE t5(c1 DOUBLE AUTO_INCREMENT KEY, c2 CHAR(10), c3 VARCHAR(100), c4 DATE, c5 TEXT)
ROW_FORMAT=DYNAMIC  ENGINE=InnoDB  DATA DIRECTORY='MYSQL_TMP_DIR/alternate_dir';
INSERT INTO t5 VALUES (1000000000, 'MySQL', 'InnoDB', '2011-11-11', 'Read this after reboot');
INSERT INTO t5 (SELECT 0, c2, c3, c4, c5 FROM t5);
INSERT INTO t5 (SELECT 0, c2, c3, c4, c5 FROM t5);
INSERT INTO t5 (SELECT 0, c2, c3, c4, c5 FROM t5);
INSERT INTO t5 (SELECT 0, c2, c3, c4, c5 FROM t5);
SHOW CREATE TABLE t5;
Table	Create Table
t5	CREATE TABLE `t5` (
  `c1` double NOT NULL AUTO_INCREMENT,
  `c2` char(10) DEFAULT NULL,
  `c3` varchar(100) DEFAULT NULL,
  `c4` date DEFAULT NULL,
  `c5` text,
  PRIMARY KEY (`c1`)
) ENGINE=InnoDB AUTO_INCREMENT=1000000027 DEFAULT CHARSET=latin1 ROW_FORMAT=DYNAMIC DATA DIRECTORY='MYSQL_TMP_DIR/alternate_dir/'
SELECT count(*) FROM t5;
count(*)
16
SELECT name,n_cols,file_format,row_format
FROM information_schema.innodb_sys_tables WHERE name like 'test%';
name	n_cols	file_format	row_format
test/t1	8	Antelope	Redundant
test/t2	8	Antelope	Compact
test/t3	8	Barracuda	Compressed
test/t4	8	Barracuda	Dynamic
test/t5	8	Barracuda	Dynamic
SELECT name,file_format,row_format
FROM information_schema.innodb_sys_tablespaces;
name	file_format	row_format
test/t1	Antelope	Compact or Redundant
test/t2	Antelope	Compact or Redundant
test/t3	Barracuda	Compressed
test/t4	Barracuda	Dynamic
test/t5	Barracuda	Dynamic
SELECT path FROM information_schema.innodb_sys_datafiles;
path
MYSQLD_DATADIR/test/t1.ibd
MYSQLD_DATADIR/test/t2.ibd
MYSQLD_DATADIR/test/t3.ibd
MYSQLD_DATADIR/test/t4.ibd
MYSQL_TMP_DIR/alternate_dir/test/t5.ibd
# Restart the server
SHOW VARIABLES LIKE 'innodb_file_per_table';
Variable_name	Value
innodb_file_per_table	OFF
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `c1` double NOT NULL AUTO_INCREMENT,
  `c2` char(10) DEFAULT NULL,
  `c3` varchar(100) DEFAULT NULL,
  `c4` date DEFAULT NULL,
  `c5` text,
  PRIMARY KEY (`c1`)
) ENGINE=InnoDB AUTO_INCREMENT=1000000020 DEFAULT CHARSET=latin1 ROW_FORMAT=REDUNDANT
SHOW CREATE TABLE t2;
Table	Create Table
t2	CREATE TABLE `t2` (
  `c1` double NOT NULL AUTO_INCREMENT,
  `c2` char(10) DEFAULT NULL,
  `c3` varchar(100) DEFAULT NULL,
  `c4` date DEFAULT NULL,
  `c5` text,
  PRIMARY KEY (`c1`)
) ENGINE=InnoDB AUTO_INCREMENT=1000000020 DEFAULT CHARSET=latin1 ROW_FORMAT=COMPACT
SHOW CREATE TABLE t3;
Table	Create Table
t3	CREATE TABLE `t3` (
  `c1` double NOT NULL AUTO_INCREMENT,
  `c2` char(10) DEFAULT NULL,
  `c3` varchar(100) DEFAULT NULL,
  `c4` date DEFAULT NULL,
  `c5` text,
  PRIMARY KEY (`c1`)
) ENGINE=InnoDB AUTO_INCREMENT=1000000020 DEFAULT CHARSET=latin1 ROW_FORMAT=COMPRESSED KEY_BLOCK_SIZE=4
SHOW CREATE TABLE t4;
Table	Create Table
t4	CREATE TABLE `t4` (
  `c1` double NOT NULL AUTO_INCREMENT,
  `c2` char(10) DEFAULT NULL,
  `c3` varchar(100) DEFAULT NULL,
  `c4` date DEFAULT NULL,
  `c5` text,
  PRIMARY KEY (`c1`)
) ENGINE=InnoDB AUTO_INCREMENT=1000000020 DEFAULT CHARSET=latin1 ROW_FORMAT=DYNAMIC
SHOW CREATE TABLE t5;
Table	Create Table
t5	CREATE TABLE `t5` (
  `c1` double NOT NULL AUTO_INCREMENT,
  `c2` char(10) DEFAULT NULL,
  `c3` varchar(100) DEFAULT NULL,
  `c4` date DEFAULT NULL,
  `c5` text,
  PRIMARY KEY (`c1`)
) ENGINE=InnoDB AUTO_INCREMENT=1000000020 DEFAULT CHARSET=latin1 ROW_FORMAT=DYNAMIC DATA DIRECTORY='MYSQL_TMP_DIR/alternate_dir/'
INSERT INTO t1 (SELECT 0, c2, c3, c4, c5 FROM t1);
INSERT INTO t2 (SELECT 0, c2, c3, c4, c5 FROM t2);
INSERT INTO t3 (SELECT 0, c2, c3, c4, c5 FROM t3);
INSERT INTO t4 (SELECT 0, c2, c3, c4, c5 FROM t4);
INSERT INTO t5 (SELECT 0, c2, c3, c4, c5 FROM t5);
SELECT count(*) FROM t1;
count(*)
32
SELECT count(*) FROM t2;
count(*)
32
SELECT count(*) FROM t3;
count(*)
32
SELECT count(*) FROM t4;
count(*)
32
SELECT count(*) FROM t5;
count(*)
32
SELECT name,n_cols,file_format,row_format
FROM information_schema.innodb_sys_tables WHERE name like 'test%';
name	n_cols	file_format	row_format
test/t1	8	Antelope	Redundant
test/t2	8	Antelope	Compact
test/t3	8	Barracuda	Compressed
test/t4	8	Barracuda	Dynamic
test/t5	8	Barracuda	Dynamic
SELECT name,file_format,row_format
FROM information_schema.innodb_sys_tablespaces;
name	file_format	row_format
test/t1	Antelope	Compact or Redundant
test/t2	Antelope	Compact or Redundant
test/t3	Barracuda	Compressed
test/t4	Barracuda	Dynamic
test/t5	Barracuda	Dynamic
SELECT path FROM information_schema.innodb_sys_datafiles;
path
MYSQLD_DATADIR/test/t1.ibd
MYSQLD_DATADIR/test/t2.ibd
MYSQLD_DATADIR/test/t3.ibd
MYSQLD_DATADIR/test/t4.ibd
MYSQL_TMP_DIR/alternate_dir/test/t5.ibd
DROP TABLE t1;
DROP TABLE t2;
DROP TABLE t3;
DROP TABLE t4;
#
# Truncate the remote tablespace and restart.
#
TRUNCATE TABLE t5;
SELECT path FROM information_schema.innodb_sys_datafiles;
path
MYSQL_TMP_DIR/alternate_dir/test/t5.ibd
INSERT INTO t5 VALUES (1000000000, 'MySQL', 'InnoDB', '2011-11-11', 'Read this after reboot');
INSERT INTO t5 (SELECT 0, c2, c3, c4, c5 FROM t5);
SELECT count(*) FROM t5;
count(*)
2
SHOW CREATE TABLE t5;
Table	Create Table
t5	CREATE TABLE `t5` (
  `c1` double NOT NULL AUTO_INCREMENT,
  `c2` char(10) DEFAULT NULL,
  `c3` varchar(100) DEFAULT NULL,
  `c4` date DEFAULT NULL,
  `c5` text,
  PRIMARY KEY (`c1`)
) ENGINE=InnoDB AUTO_INCREMENT=1000000002 DEFAULT CHARSET=latin1 ROW_FORMAT=DYNAMIC DATA DIRECTORY='MYSQL_TMP_DIR/alternate_dir/'
# Restart the server
SHOW VARIABLES LIKE 'innodb_file_per_table';
Variable_name	Value
innodb_file_per_table	OFF
SELECT path FROM information_schema.innodb_sys_datafiles;
path
MYSQL_TMP_DIR/alternate_dir/test/t5.ibd
INSERT INTO t5 (SELECT 0, c2, c3, c4, c5 FROM t5);
SELECT count(*) FROM t5;
count(*)
4
SHOW CREATE TABLE t5;
Table	Create Table
t5	CREATE TABLE `t5` (
  `c1` double NOT NULL AUTO_INCREMENT,
  `c2` char(10) DEFAULT NULL,
  `c3` varchar(100) DEFAULT NULL,
  `c4` date DEFAULT NULL,
  `c5` text,
  PRIMARY KEY (`c1`)
) ENGINE=InnoDB AUTO_INCREMENT=1000000005 DEFAULT CHARSET=latin1 ROW_FORMAT=DYNAMIC DATA DIRECTORY='MYSQL_TMP_DIR/alternate_dir/'
#
# Rename file table and tablespace, then restart
#
RENAME TABLE t5 TO t55;
SELECT path FROM information_schema.innodb_sys_datafiles;
path
MYSQL_TMP_DIR/alternate_dir/test/t55.ibd
INSERT INTO t55 (SELECT 0, c2, c3, c4, c5 FROM t55);
SELECT count(*) FROM t55;
count(*)
8
SHOW CREATE TABLE t55;
Table	Create Table
t55	CREATE TABLE `t55` (
  `c1` double NOT NULL AUTO_INCREMENT,
  `c2` char(10) DEFAULT NULL,
  `c3` varchar(100) DEFAULT NULL,
  `c4` date DEFAULT NULL,
  `c5` text,
  PRIMARY KEY (`c1`)
) ENGINE=InnoDB AUTO_INCREMENT=1000000012 DEFAULT CHARSET=latin1 ROW_FORMAT=DYNAMIC DATA DIRECTORY='MYSQL_TMP_DIR/alternate_dir/'
# Restart the server
SHOW VARIABLES LIKE 'innodb_file_per_table';
Variable_name	Value
innodb_file_per_table	OFF
SELECT path FROM information_schema.innodb_sys_datafiles;
path
MYSQL_TMP_DIR/alternate_dir/test/t55.ibd
INSERT INTO t55 (SELECT 0, c2, c3, c4, c5 FROM t55);
SELECT count(*) FROM t55;
count(*)
16
SHOW CREATE TABLE t55;
Table	Create Table
t55	CREATE TABLE `t55` (
  `c1` double NOT NULL AUTO_INCREMENT,
  `c2` char(10) DEFAULT NULL,
  `c3` varchar(100) DEFAULT NULL,
  `c4` date DEFAULT NULL,
  `c5` text,
  PRIMARY KEY (`c1`)
) ENGINE=InnoDB AUTO_INCREMENT=1000000024 DEFAULT CHARSET=latin1 ROW_FORMAT=DYNAMIC DATA DIRECTORY='MYSQL_TMP_DIR/alternate_dir/'
# Restart the server
#
# Move the remote tablespace to a new location and change the ISL file
#
# Copying tablespace to new_dir
# Restart the server
SELECT path FROM information_schema.innodb_sys_datafiles;
path
MYSQL_TMP_DIR/new_dir/test/t55.ibd
INSERT INTO t55 (SELECT 0, c2, c3, c4, c5 FROM t55);
SELECT count(*) FROM t55;
count(*)
32
SHOW CREATE TABLE t55;
Table	Create Table
t55	CREATE TABLE `t55` (
  `c1` double NOT NULL AUTO_INCREMENT,
  `c2` char(10) DEFAULT NULL,
  `c3` varchar(100) DEFAULT NULL,
  `c4` date DEFAULT NULL,
  `c5` text,
  PRIMARY KEY (`c1`)
) ENGINE=InnoDB AUTO_INCREMENT=1000000048 DEFAULT CHARSET=latin1 ROW_FORMAT=DYNAMIC DATA DIRECTORY='MYSQL_TMP_DIR/new_dir/'
# Restart the server
#
# Move the remote tablespace back to the default datadir and delete the ISL file.
#
FLUSH TABLE t55 WITH READ LOCK;
# Copying tablespace to default datadir
UNLOCK TABLES;
# Restart the server
SELECT path FROM information_schema.innodb_sys_datafiles;
path
MYSQLD_DATADIR/test/t55.ibd
INSERT INTO t55 (SELECT 0, c2, c3, c4, c5 FROM t55);
SELECT count(*) FROM t55;
count(*)
64
SHOW CREATE TABLE t55;
Table	Create Table
t55	CREATE TABLE `t55` (
  `c1` double NOT NULL AUTO_INCREMENT,
  `c2` char(10) DEFAULT NULL,
  `c3` varchar(100) DEFAULT NULL,
  `c4` date DEFAULT NULL,
  `c5` text,
  PRIMARY KEY (`c1`)
) ENGINE=InnoDB AUTO_INCREMENT=1000000096 DEFAULT CHARSET=latin1 ROW_FORMAT=DYNAMIC
DROP TABLE t55;
#
# Cleanup
#
